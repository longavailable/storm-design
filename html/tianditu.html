<!DOCTYPE html> 
<html> 
<head> 
<meta http-equiv="content-type" content="text/html; charset=utf-8"/> 
<meta name="keywords" content="天地图web应用"/> 
<title>天地图－地图API</title>
<style type="text/css">body,html{width:100%;height:100%;margin:0;font-family:"Microsoft YaHei"}#mapDiv{width:30%;height:400px}input,b,p{margin-left:5px;font-size:14px}</style>
<script type="text/javascript" src="https://api.tianditu.gov.cn/api?v=4.0&tk=403b9ac6155d03e40f0cfb3c61800099"></script>
<script src="https://cdn.jsdelivr.net/gh/longavailable/jQuery-city-selector@main/jquery-1.7.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/longavailable/jQuery-city-selector@main/Area.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/longavailable/jQuery-city-selector@main/AreaData_min.js" type="text/javascript"></script>
<script type="text/javascript">
	var map;
	var zoom = 12;
	var geocoder;
	function onLoad()
	{
		/*
		// 配置卫星影像地图
		var imageURL = "http://t0.tianditu.gov.cn/img_w/wmts?" +
                "SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles" +
                "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=403b9ac6155d03e40f0cfb3c61800099";
		//创建自定义图层对象
		lay = new T.TileLayer(imageURL, {minZoom: 1, maxZoom: 18});
		var config = {layers: [lay]};
		
		map = new T.Map("mapDiv", config);	// 卫星影像地图
		*/
		
		//初始化地图对象
		/*
		map = new T.Map("mapDiv"); // EPSG:3857 球面墨卡托，网页地图默认投影 https://epsg.io/3857
		map = new T.Map('mapDiv', { projection: 'EPSG:4326' });	// WGS 1984地理坐标系，经纬度直投 https://epsg.io/4326
		*/
	   	//
		map = new T.Map("mapDiv", {datasourcesControl: true});
		
		//坐标实例：默认坐标，江苏满江春
		var lnglat = new T.LngLat(119.48035,32.20632);
				
	   	//设置显示地图的中心点和级别
		map.centerAndZoom( lnglat, zoom );
		 
		//创建对象 
		geocoder = new T.Geocoder();
		
		//地图类型控件：地图、地形、卫星
		var ctrl = new T.Control.MapType();
		//添加控件
		map.addControl(ctrl);
		
	} 
	
	function searchResult(result)
	{
		if(result.getStatus() == 0){
			var coords = result.getLocationPoint(); //获取经纬度坐标
			map.panTo(coords, 16);
			
			/*
			//添加标注图层
			//创建标注对象
	        var marker = new T.Marker(coords);
	        //向地图上添加标注
	        map.addOverLay(marker);
			
			var addressMsg = result.getAddress();
			var addressComponent = result.getAddressComponent();
			alert(coords.getLng());
			alert(coords.getLat());
			alert(addressMsg);
			alert(addressComponent.address);
			*/
					
			var coords = map.getCenter();
			geocoder.getLocation(coords, searchResult2);
			
		}else{
			alert(result.getMsg());
		}
		
	}
	
	function searchResult2(result)
	{
		if(result.getStatus() == 0){
			var addressMsg = result.getAddress();
			var addressComponent = result.getAddressComponent();
			//alert(addressMsg);
			//alert(addressComponent.city);
			document.getElementById("addressMsg").innerHTML = "<font style='font-weight:700'>详细地址：</font>" + addressMsg;
			//document.getElementById("addressMsg").innerHTML = "<font style='font-weight:700'>省市区：</font>" + addressComponent.city;
			adminRegion = extractProvinceCityDistrict(addressMsg);
			//alert(adminRegion);
			document.getElementById("adminRegion").innerHTML = "<font style='font-weight:700'>详细地址：</font>" + adminRegion;
			
		}else{
			alert(result.getMsg());
		}
		
	}
	function search(){
		map.clearOverLays();
		//检查输入
		//alert(document.getElementById("searchPoint").value);
		geocoder.getPoint(document.getElementById("searchPoint").value, searchResult);

		//alert("当前地图中心点：" + map.getCenter().getLng() + "," + map.getCenter().getLat());
		//alert("当前地图中心点：" + map.getCenter().getLng() + "," + map.getCenter().getLat());
		/*
		var tt = "http://api.tianditu.gov.cn/reverseGeocoding?lon=" + map.getCenter().getLng() +
			"&lat=" + map.getCenter().getLat() +
			"&level=district&tk=403b9ac6155d03e40f0cfb3c61800099";
		*/
		//alert(map.getArea());
	}
	
	function search2(){
		map.clearOverLays();
		//检查输入
		//alert(getAreaName());
		geocoder.getPoint(getAreaName(), searchResult);
	}
	
	//jQuery 初始化 城市选择器
	$(function (){
		initComplexArea('searchprov', 'searchcity', 'searchdistrict', area_array, sub_array, '32', '3211', '0');
	});

	function getAreaName() {
		var areaName = "";
		if($("#searchdistrict").val() != "0"){
			areaName = $("#searchdistrict option:selected").text();
		}
		if ($("#searchcity").val() != "0"){
			areaName = $("#searchcity option:selected").text() + areaName;
		}
		if ($("#searchprov").val() != "0"){
			areaName = $("#searchprov option:selected").text() + areaName;
		}
		return areaName;
	}
	/*
	function getAreaName() {
		//地区码
		var areaID = getAreaID();
		//地区名
		var areaName = getAreaNamebyID(areaID) ;
		return areaName;
	}
	*/
	//得到地区码
	function getAreaID(){
		var area = 0;          
		if($("#searchdistrict").val() != "0"){
			area = $("#searchdistrict").val();                
		}else if ($("#searchcity").val() != "0"){
			area = $("#searchcity").val();
		}else{
			area = $("#searchprov").val();
		}
		return area;
	}
		
	function showAreaID() {
		//地区码
		var areaID = getAreaID();
		//地区名
		var areaName = getAreaNamebyID(areaID) ;
		map.clearOverLays();
		geocoder.getPoint(areaName, searchResult);
		alert("您选择的地区码：" + areaID + "      地区名：" + areaName);            
	}

	//根据地区码查询地区名
	function getAreaNamebyID(areaID){
		var areaName = "";
		if(areaID.length == 2){
			areaName = area_array[areaID];
		}else if(areaID.length == 4){
			var index1 = areaID.substring(0, 2);
			//areaName = area_array[index1] + " " + sub_array[index1][areaID];
			areaName = area_array[index1] + sub_array[index1][areaID];
		}else if(areaID.length == 6){
			var index1 = areaID.substring(0, 2);
			var index2 = areaID.substring(0, 4);
			//areaName = area_array[index1] + " " + sub_array[index1][index2] + " " + sub_arr[index2][areaID];
			areaName = area_array[index1] + sub_array[index1][index2] + sub_arr[index2][areaID];
		}
		return areaName;
	}
	function extractProvinceCityDistrict(address) {
		/*
		const regex = /^([^\s]+(省|自治区|市|特别行政区|自治州|地区|盟|区|县|旗))/;
		const adminRegion = address.match(regex);
		return (adminRegion ? adminRegion[0].trim() : '');
		*/
		// 预处理地址
		address = address.replace(/(集市|另一个例外词)/gi, '***');
		
		// 定义正则表达式，考虑多种情况
		const provinceRegex = /^(.+?(省|自治区|市|特别行政区|))/;
		const cityRegex = /(.+?(市|自治州|地区|盟))/;
		const districtRegex = /(.+?(区|县|市|旗))/;
		
		let province = '', city = '', district = '';
		
		//逐级匹配，并去除已匹配部分
		let match = address.match(provinceRegex);
		if (match) {
			province = match[0].trim();
			address = address.replace(province, '');
		}
		
		match = address.match(cityRegex);
		if (match) {
			city = match[0].trim();
			address = address.replace(city, '');
		}
		
		match = address.match(districtRegex);
		if (match) {
			district = match[0].trim();
		}
		
		return (province + city + district);
	}

</script>
<script>
    //表单提交
	const form = document.getElementById('testForm');

	form.addEventListener('submit', (event) => {
	event.preventDefault();

	const formData = new FormData(form);
	const data = Object.fromEntries(formData.entries());

	fetch('https://storm-design-request-mail.longlovemyu.com', 
    {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
	})
	.then(response => response.json())
	.then(data => {
        console.log('Success:', data);
        alert('提交成功！感谢您的反馈。');
        form.reset(); // 重置表单
	})
	.catch((error) => {
        console.error('Error:', error);
        alert('提交失败，请稍后再试。');
	});
	});
</script>

</head> 
<body onLoad="onLoad()"> 
	
	<div id="directSearch">
		<label>直接输入地点：</label>
		<input type="text" id="searchPoint" value="镇江市京口区梦溪路253号" />
		<input type="button" value="搜索" onclick="search();" />
	</div>
	
	<div id="citySelect">
		<label>或选择省市地区：</label>
		<select id="searchprov" name="searchprov" onChange="changeComplexProvince(this.value, sub_array, 'searchcity', 'searchdistrict');search2();"></select>&nbsp;&nbsp;
		<select id="searchcity" name="searchcity" onChange="search2();changeCity(this.value,'searchdistrict');"></select>&nbsp;&nbsp;
		<span id="searchdistrict_div"><select id="searchdistrict" name="searchdistrict" onChange="search2();"></select></span>
		<!--
		<input type="button"  value="定位地点" onClick="search2();"/>
		-->
	</div>
    
	<div id="mapDiv"></div>
	<div id="mapStyle">
		<label>地图显示样式：</label>
		<input type="button" onClick="map.setStyle('black')" value="Black"/>
		<input type="button" onClick="map.setStyle('indigo')" value="Indigo"/>
		<input type="button" onClick="map.removeStyle()" value="Light"/> <!--默认显示样式-->
	</div>
	
	<div id="addressMsg" style="font-size:14px"></div>
	<div id="adminRegion" style="font-size:14px"></div>
	<form id="testForm">
	  <input type="text" name="name" placeholder="姓名" required>
	  <input type="email" name="email" placeholder="邮箱" required>
	  <input type="text" name="message" placeholder="留言" required>
	  <button type="submit">提交</button>
	</form>
</body> 
</html>